name: MLProject

on:
  # Trigger saat ada push ke branch main
  push:
    branches:
      - main
  # Trigger manual dari tab Actions
  workflow_dispatch:

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "Starting training job"

      # ========================
      # 1. Checkout repository
      # ========================
      - name: Run actions/checkout@v3
        uses: actions/checkout@v3

      # ========================
      # 2. Setup Python & Conda
      # ========================
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"

      - name: Check Env
        run: python --version

      - name: Install dependencies (Conda)
        uses: conda-incubator/setup-miniconda@v2
        with:
          # Menggunakan nama environment yang disarankan
          activate-environment: workflow-ci
          environment-file: MLProject/conda.yaml
          auto-activate-base: false

      # ========================
      # 3. Run MLflow Project
      # ========================
      - name: Run mlflow project
        # Gunakan shell bash -l {0} untuk memastikan Conda env loaded
        shell: bash -l {0} 
        run: |
          echo "üöÄ Menjalankan proyek MLflow dengan parameter..."
          # Pindah ke direktori proyek dan jalankan MLflow
          cd MLProject
          mlflow run . -P data_path=Preprocessed_Dry_Bean.csv || { echo "‚ùå Training dengan MLflow gagal"; exit 1; }

      # ========================
      # 4. Handle Run ID & MLflow Utility
      # ========================
      # Langkah ini adalah placeholder yang Anda minta
      - name: Get latest MLflow run_id
        run: echo "Handled internally by MLflow"

      # Install MLflow CLI (Jika belum ada di conda.yaml)
      - name: Install Python dependencies
        run: pip install mlflow

      # ========================
      # 5. Prepare and Upload Artifacts
      # ========================
      - name: Upload to Google Drive (Prepare artifacts)
        run: |
          echo "üì¶ Menyiapkan folder mlruns untuk diunggah..."
          # Membuat struktur folder 'saved_artifacts'
          mkdir -p saved_artifacts
          # Menyalin hasil tracking MLflow lokal ke folder yang akan diunggah
          cp -r MLProject/mlruns saved_artifacts/mlruns

      - name: Upload MLruns as artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlruns
          path: saved_artifacts/mlruns/